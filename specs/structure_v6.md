
# Спецификация формата .structure 6-ой версии для Sandbox World

## Вспомогательная информация

Примитивные структуры в формате, такие как числа и строки, имеют порядок байт Big Endian.

## Базовые вспомогательные структуры

#### **array** - Массив для любого типа. Длина составляет 2 байта и представлена в виде беззнакового 16-и битного числа. Общий размер зависит от типа и может быть вычислен по следующей формуле: `[размер одного обьекта с указанным типом] * [длина массива] + 2`

#### **array255** - Массив для любого типа. Длина составляет 1 байт. Общий размер зависит от типа и может быть вычислен по следующей формуле: `[размер одного обьекта с указанным типом] * [длина массива] + 1`

#### **vec3_u16** - Трёхмерный вектор, каждый компонент которого представлен в виде беззнакового 16-и битного целого числа. Размер составляет 6 байт.

#### **vec3_i16** - Трёхмерный вектор, каждый компонент которого представлен в виде знакового 16-и битного целого числа. Размер составляет 6 байт.

#### **vec3_f32** - Трёхмерный вектор, каждый компонент которого представлен в виде плавающего числа одинарной точности по стандарту **IEEE-754**. Размер составляет 12 байт.

#### **color_888** - Цвет **RGB**, где на каждый компонент выделено по 8 бит. Размер составляет 3 байта.
#### **color_565** - Цвет **RGB**, где 5 бит выделено на компоненты **R** и **B**, а на **G** 6. Размер составляет 2 байта.

#### **gradient** - Градиент, состоящий из четырёх массивов. Первый и третий массив хранят в себе ключи, второй и четвертый позиции ключей от 0 до 1.
#### Первый массив состоит из **RGB** цветов типа **color_888**, а второй массив хранит в себе позицию каждого цвета в градиенте от нуля до единицы и каждая позиция представлена в виде ранее упомянутого плавающего числа.
####  Третий массив состоит из ключей прозрачности, где каждый ключ представлен в виде ранее упомянутого плавающего числа, а четвертый массив выполняет функцию второго, но для третьего.
#### Посчитать общий размер градиента в байтах можно по следующей формуле: `3 * [количество цветных ключей] + 4 * [количество прозрачных ключей] + 8`, где 3 - размер **color_888**, 4 - размер выше упомянутого плавающего числа, 8 - суммарный объем байт, выделенных на длину каждого массива (2 * 4)

#### **packed_bools_255** - Представляет из себя массив булевов, в котором 8 булевов занимает 1 байт. Длина составляет 1 байт. Общий размер зависит от количества и может быть вычислен по следующей формуле: `ceil([кол-во булевов] / 8) + 1`

# Секции

Файлы структур разбиты на три секции:
### **Заголовок, Руты, Блоки**

Заголовок содержит в себе версию и таблицы для некоторых повторяющихся компонентов блоков.

В рутах содержится информация о каждом руте, такая как: Позиция и вращение рута относительно центра постройки; Центр и размеры границ рута, а также индекс последнего блока, относящегося к руту, относительно массива блоков в третьей секции.

В блоках содержится информация о каждом блоке, такая как: ID блока; Позиция и вращение блока; Индекс подшипника, к которому блок подключён и т. д.

# Заголовок


|         Тип         |         Имя          |                                                                                                                                                                                     Описание                                                                                                                                                                                     |      Длина (В байтах)       |
| :-----------------: | :------------------: | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |:---------------------------:|
|        byte         |        Версия        |                                                                                                                                                                    Содержит в себе числовой ID версии формата                                                                                                                                                                    |              1              |
| array255<color_565> |  Таблица с цветами   |                                         Содержит в себе массив с часто повторяющимися цветами в блоках. Полностью записывается только в том случае, если эффективность такого сжатия больше двух, т.е. результат деления общего кол-ва цветов в блоках на кол-во цветов в таблице больше двух. В ином случае, длина будет равна $2^{8}$                                          |  `[кол-во цветов] * 2 + 1`  |
|   array<vec3_u16>   | Таблица с вращениями | Содержит в себе массив с часто повторяющимися вращениями в блоках. Полностью записывается только в двух случаях: 1) Индекс к любому из элементов массива можно представить одним байтом и эффективность сжатия больше 1.2      2) Индекс к любому элементу массива можно представить двумя байтами, а эффективность сжатия больше 1.5. В ином случае, длина будет равна $2^{16}$ | `[кол-во вращений] * 6 + 2` |




# Руты

Перед рутами определено их количество в виде 16-и битного целого беззнакового числа.

Сам рут имеет следующую структуру:

|   Тип    |           Имя           |                     Описание                      | Длина (В байтах) |
| :------: | :---------------------: | :-----------------------------------------------: | :--------------: |
| vec3_f32 |         Позиция         |                         -                         |        12        |
| vec3_f32 |        Вращение         |                         -                         |        12        |
| vec3_f32 |      Центр границ       |      Центр области, в которой находится рут       |        12        |
| vec3_f32 |      Размер границ      |     Размеры области, в которой находится рут      |        12        |
|  uint16  | Индекс последнего блока | Индекс последнего блока, который находится в руте |        2         |

# Блоки

Перед блоками определено их количество в виде 16-и битного целого беззнакового числа.

Одиночный блок имеет следующую структуру:


|        Тип         |                 Имя                  |                                                                                                                                                                                                                                                     Описание                                                                                                                                                                                                                                                     |            Длина (В байтах)            |
| :----------------: | :----------------------------------: |:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:| :------------------------------------: |
|      vec3_i16      |               Позиция                |               Позиция блока относительно рута. Каждый компонент закодирован по следующей формуле: `(преобразование в 16-и битное знаковое число) ( ([исходный компонент позиции блока] - [компонент центра границ рута]) * [обратная компонента размера границ рута, умноженная на 2^15-1] )` и по следующей формуле каждый компонент декодируется: `[закодированный компонент позиции блока] / [обратная компонента размера границ рута, умноженная на 2^15-1] + [компонент центра границ рута]`                |                   6                    |
|   byte \| uint16   |           Индекс вращения            |                                                                                                                                          Индекс вращения блока в таблице вращений из заголовка. Записывается только в том случае, если таблица вращений используется. Если индекс вращения может быть представлен одним байтом - записывается одним байтом. Иначе двумя                                                                                                                                          |                 1 \| 2                 |
|      vec3_u16      |            Вращение блока            |                                                                                                              Вращение блока. Каждый компонент закодирован по следующей формуле: `[исходный компонент вращения блока] * (2047 / 360)` и декодируется следующей: `[закодированный компонент вращения блока] / (2047 / 360)`. Записывается только в том случае, если отсутствует индекс вращения блока                                                                                                              |                   12                   |
|        byte        |               ID блока               |                                                                                                                                                                                                                                  Представляет из себя идентификатор типа блока                                                                                                                                                                                                                                   |                   1                    |
|        byte        |     Маска, определяющая свойства     | Содержит в себе маску из 8 булевов, каждый из которых отвечает за присутствие некоторого свойства в данных блока. 1 бит - Содержит ли блок определенное игроком название; 2 бит - Имеет ли блок подключения; 3 бит - Блок не имеет специфичных настроек; 4 бит - Блок не имеет специфичного цвета; 5 бит - Блок не подключён к подшипнику; 6 бит - В блоке отсутствуют дополнительные целые числа (мелкие метаданные); 7 бит - Скорость работы блока больше единицы; 8 бит - Скорость работы блока не равна нулю |                   1                    |
|        byte        |           Скорость работы            |                                                                                                                          Записывается только в том случае, если 8 бит маски не равен нулю или тип блока интерактивный. Если 7 бит маски истин, то скорость работы блока конвертируется из плавающего числа в байт и записывается. Иначе, умножается на 255 и в таком виде записывается                                                                                                                           |                   1                    |
|        utf8        |      Пользовательское название       |                                                                                                                                                                                                                Записывается только в том случае, если тип блока интерактивный и 1 бит маски истин                                                                                                                                                                                                                |               Динамична                |
|        byte        |           Уровень сигнала            |                                                                                                                                                                                                                          Записывается только в том случае, если тип блока интерактивный                                                                                                                                                                                                                          |                   1                    |
|       uint16       |          Индекс подшипника           |                                                                                                                                                                                   Индекса подшипника, к которому подключен текущий блок. Записывается только в том случае, если тип блока интерактивный и 5 бит маски не истин                                                                                                                                                                                   |                   2                    |
| array255< uint16 > |     Индексы подключенных блоков      |                                                                                                                                                                                                                Записывается только в том случае, если тип блока интерактивный и 2 бит маски истин                                                                                                                                                                                                                | `[кол-во подключённых блоков] * 2 + 1` |
| array255< int32 >  |      Дополнительные целые числа      |                                                                                                                                                                                                                 Записывается только в том случае, если тип блока интерактивный и 6 бит не истин                                                                                                                                                                                                                  |  `[кол-во доп. целых чисел] * 4 + 1`   |
|  Метаданные блока  |           Метаданные блока           |                                                                                                                                                                                                                 Записывается только в том случае, если тип блока интерактивный и 3 бит не истин                                                                                                                                                                                                                  |               Динамична                |
|        byte        | Индекс пользовательского цвета блока |                                                                                                                                                                       Записывается только в том случае, если 4 бит не истин и в заголовке определена таблица повторяющихся цветов. Представляет из себя индекс на один из цветов в таблице                                                                                                                                                                       |                   1                    |
|     color_565      |     Пользовательский цвет блока      |                                                                                                                                                                                                  Записывается только в том случае, если 4 бит не истин и таблица повторяющихся цветов в заголовке не определена                                                                                                                                                                                                  |                   2                    |

# Метаданные блока


|                   Тип                   |                                       Имя                                       |                                                                                                                                                                                                                                                                   Описание                                                                                                                                                                                                                                                                   |            Длина (В байтах)             |
| :-------------------------------------: | :-----------------------------------------------------------------------------: | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: | :-------------------------------------: |
|            packed_bools_255             |                              Дополнительные булевы                              |                                                                                                                                                                                 Дополнительные булевы, которые полностью могут использоваться в качестве метаданных для любого блока. В основном, используется для всяких галочек и т. п. в настройках блока                                                                                                                                                                                 |    `ceil([кол-во булевов] / 8) + 1`     |
|             array255< f32 >             |                         Дополнительные плавающие числа                          |                                                                                                                                                                                 Дополнительные плавающие числа, которые могут полностью использоваться в качестве метаданных блока. В основном, используется для всяких ползунков и т. п. в настройках блока                                                                                                                                                                                 |        `[кол-во чисел] * 4 + 1`         |
|                  byte                   |                Длина векторов/Дополнительного двумерного массива                |                                                                                                                                                                     Если блок кастомный, то записывается кол-во вершин. Иначе: Если в метаданных есть векторы, то записывается длина дополнительного двумерного массива + 127. Иначе только длина доп. двумер. массива.                                                                                                                                                                      |                    1                    |
|           array255<vec3_f32>            |                                     Векторы                                     |                                                                                                                                                                       Записывается только если блок не кастомный и в метаданных есть вершины. Если предыдущее поле больше или равно 127 и предыдущие условия истины, то это сигнал о том, что данное поле присутствует                                                                                                                                                                       |      `[кол-во векторов] * 12 + 1`       |
|                  sbyte                  |                        Мин. значение компонентов вершин                         |                                                                          Сначала их всех вершин составляется вектор с минимальными компонентами по следующей формуле: `vec3( min(a.x, b.x, ...), min(a.y, b.y, ...), min(a.z, b.z, ...) )`. После этого выбирается наименьший компонент вычисленного вектора, округляется к меньшему, приводится к знаковому байту и записывается в это поле. Записывается только если блок кастомный и имеет вершины в метаданных                                                                           |                    1                    |
|                  sbyte                  |                        Макс. значение компонентов вершин                        |                                                    Способ вычисления схож с предыдущим полем. Сначала их всех вершин составляется вектор с максимальными компонентами по следующей формуле: `vec3( max(a.x, b.x, ...), max(a.y, b.y, ...), max(a.z, b.z, ...) )`. После этого выбирается наибольший компонент вычисленного вектора, округляется к большему, приводится к знаковому байту и записывается в это поле. Записывается только если блок кастомный и имеет вершины в метаданных                                                     |                    1                    |
|     Последовательность из vec3_u16      |                            Вершины кастомного блока                             | Записывается только если блок кастомный и поле с длиной векторов больше нуля. Компонент каждой вершины кодируется по следующей формуле: `(преобразование в 16-и битное беззнаковое число) ( ([исходный компонент вершины] - [мин. значение компонентов вершин]) / ([макс. значение компонентов вершин] - [мин. значение компонентов вершин]) * 2^16 )` и декодируется по этой: `[закодированный компонент вершины] / 2^16 * ([макс. значение компонентов вершин] - [мин. значение компонентов вершин]) - [мин. значение компонентов вершин]` |         `[кол-во векторов] * 6`         |
| Последовательность из array255<uint_16> |                         Дополнительный двумерный массив                         |                                                                                                   Если блок кастомный, то длина всегда будет равна нулю. Если же блок не кастомный и в метаданных присутствуют вектора, то длина равна результату вычитания из изначальной длины 127-и. Если же блок не кастомный и векторов нет, то длина остается неизменной. Используется, например, для распределения подключений к сидению по группам                                                                                                   |                Динамична                |
|                  byte                   | Длина дополнительных байт и маска, определяющая присутствие цветов и градиентов |                                                                                                                                                                                                        Первые 6 бит - Длина дополнительных байт; 7 бит - Присутствие цветов в метаданных; 8 бит - Присутствие градиентов в метаданных                                                                                                                                                                                                        |                    1                    |
|      Последовательность из байтов       |                              Дополнительные байты                               |                                                                                                                                                                   Длина равняется первым 6 -и битам предыдущего поля. Таким образом, максимальная длина равна 64. Используется в основном для всяких выпадающих полей с некоторыми вариантами на выбор в настройках блока                                                                                                                                                                    |       `[предыдущее поле] & 0x3F`        |
|           array255<color_888>           |                              Дополнительные цвета                               |                                                                                                                                                                                                                                          Записывается только если 7 бит выше упомянутой маски истин                                                                                                                                                                                                                                          |        `[кол-во цветов] * 3 + 1`        |
|          array255< gradient >           |                            Дополнительные градиенты                             |                                                                                                                                                                                                                                          Записывается только если 8 бит выше упомянутой маски истин                                                                                                                                                                                                                                          | См. определение `array255` и `gradient` |
|                    -                    |                           Кастомные метаданные блока                            |                                                                                                                                                                                           Дополнительные метаданные специфичные для каждого блока. Присутствуют только если всех выше упомянутых полей недостаточно для хранения всех данных блока                                                                                                                                                                                           |                Динамична                |

# Кастомные метаданные блоков

На данный момент кастомные метаданные имеет только математический блок и они имеют следующую структуру:


|       Тип        |                     Имя                     |                                      Описание                                      |     Длина (В байтах)     |
| :--------------: | :-----------------------------------------: | :--------------------------------------------------------------------------------: | :----------------------: |
|  array< byte >   |                   Формула                   |         Хранит в себе формулу мат. блока представленную в кодировке ASCII          | `[кол-во символов] + 2`  |
| array255< byte > |     Идентификаторы входных подключений      | Позволяет индексировать входные подключения, позиции которых в мат. блоке сдвинуты | `[кол-во элементов] + 1` |
| array255< byte > | Позиции идентификаторов входных подключений |                 Хранит в себе позиции входных подключений в слотах                 | `[кол-во элементов] + 1` |

#### Подробная информация о двух последних полях

У мат. блока есть входные подключения и слоты, а входные подключения можно перемещать по слотам. В первом массиве у элементов значение - индекс подключения, а ключ (индекс) - идентификатор этого подключения в мат. блоке. Во втором массиве у элементов значение является позицией в слотах для подключения с идентификатором ключа.

# Типы блоков

|  ID   |                Имя                | Интерактивный | Кастомный |
| :---: |:---------------------------------:|:-------------:| :-------: |
|   0   |           Блок металла            |       -       |     -     |
|   1   |            Блок дерева            |       -       |     -     |
|   2   |  Маленький реактивный двигатель   |       +       |     -     |
|   4   |              Монитор              |               |     -     |
|   5   |              Сиденье              |       +       |     -     |
|   6   |               Стол                |       -       |     -     |
|   8   |        Регулируемый понтон        |       +       |     -     |
|   9   |           Переключатель           |       +       |     -     |
|  10   |              Кнопка               |       +       |     -     |
|  11   |              Слайдер              |       +       |     -     |
|  12   |             Подшипник             |       +       |     -     |
|  13   |              Колесо               |       -       |     -     |
|  14   |       Контроллер подшипника       |       +       |     -     |
|  15   |             Двигатель             |       +       |     -     |
|  16   |          Подводный винт           |       -       |     -     |
|  17   |         Маленькое колесо          |       -       |     -     |
|  18   |         Большой двигатель         |       +       |     -     |
|  19   |              Понтон               |       -       |     -     |
|  20   |          Воздушный винт           |       -       |     -     |
|  21   |     Маленький воздушный винт      |       -       |     -     |
|  22   |      Поворачиватель сигнала       |       -       |     -     |
|  23   |    Большой ракетный двигатель     |       +       |     -     |
|  24   |            Амортизатор            |       +       |     -     |
|  25   |    Ответный блок амортизатора     |       -       |     -     |
|  26   |    Контроллер танкового шасси     |       +       |     -     |
|  28   |            Блок стекла            |       -       |     -     |
|  29   |      Декоративный вентилятор      |       -       |     -     |
|  30   |             Прожектор             |       +       |     -     |
|  31   |           Средняя пушка           |       +       |     -     |
|  32   |           Лёгкая пушка            |       +       |     -     |
| 33-38 |      Металлические полублоки      |       -       |     -     |
|  39   |        Средняя боеукладка         |       +       |     -     |
|  40   |               Крыло               |       +       |     -     |
|  41   |          Маленькое крыло          |       +       |     -     |
|  42   |         Контроллер полёта         |       +       |     -     |
|  43   |    Средний ракетный двигатель     |       +       |     -     |
|  44   |        Маленькая ракетница        |       +       |     -     |
|  45   |               Бомба               |       +       |     -     |
|  46   |            Отключатель            |       +       |     -     |
|  47   |        Включатель очереди         |       +       |     -     |
|  48   |         Средняя ракетница         |       +       |     -     |
|  49   |              Пулемет              |       +       |     -     |
|  51   |               Пила                |               |     -     |
|  52   |           Тяжёлая пушка           |       +       |     -     |
|  53   |              Камера               |       +       |     -     |
|  56   |             Лестница              |       -       |     -     |
|  57   |              Фильтр               |       +       |     -     |
|  59   |      Металлический полублок       |       -       |     -     |
|  60   |               Ховер               |       +       |     -     |
|  61   |               Балка               |       +       |     -     |
| 62-68 |       Стеклянные полублоки        |       -       |     -     |
| 69-75 |       Деревянные полублоки        |       -       |     -     |
|  76   |              Пиксель              |       +       |     -     |
|  77   |                AND                |       +       |     -     |
|  78   |                OR                 |       +       |     -     |
|  79   |               NAND                |       +       |     -     |
|  80   |                NOR                |       +       |     -     |
|  81   |                XOR                |       +       |     -     |
|  82   |               XNOR                |       +       |     -     |
|  83   |           Сглаживатель            |       +       |     -     |
|  84   |              Таймер               |       +       |     -     |
|  85   |         Датчик расстояния         |       +       |     -     |
|  86   |      Металлический полублок       |       -       |     -     |
|  87   |        Стеклянный полублок        |       -       |     -     |
|  88   |        Деревянный полублок        |       -       |     -     |
|  89   |       Маленькая боеукладка        |       +       |     -     |
|  90   |        Большая боеукладка         |       +       |     -     |
|  91   |             Табличка              |       +       |     -     |
|  92   |       Стабилизатор наклона        |       +       |     -     |
|  93   |        Стабилизатор высоты        |       +       |     -     |
|  94   |   Маленький ракетный двигатель    |       +       |     -     |
|  95   |            Рельсотрон             |       +       |     -     |
|  96   |     Большой ионный двигатель      |       +       |     -     |
|  97   |        Пятизарядная пушка         |       +       |     -     |
|  98   |     Средний ионный двигатель      |       +       |     -     |
|  99   |       Автоматическая пушка        |       +       |     -     |
|  100  |       Реактивный двигатель        |       +       |     -     |
|  101  |        Дымовой гранатомёт         |       +       |     -     |
|  102  |              Огнемёт              |       +       |     -     |
|  103  |      Камера ночного видения       |       +       |     -     |
|  104  |    Маленький ионный двигатель     |       +       |     -     |
|  105  |          Среднее колесо           |       -       |     -     |
|  106  |      Очень маленькое колесо       |       -       |     -     |
|  107  |              Магнит               |       +       |     -     |
|  108  |             Дальномер             |       +       |     -     |
|  109  |       Пользовательский блок       |       +       |     +     |
|  110  |     Турбореактивный двигатель     |       +       |     -     |
|  111  | Большой турбореактивный двигатель |       +       |     -     |
|  113  |             Наклейка              |       -       |     -     |
|  114  |         Большая ракетница         |       +       |     -     |
|  115  |         Тепловые ловушки          |       +       |     -     |
|  116  |              Балласт              |       -       |     -     |
|  117  |       Стабилизатор скорости       |       +       |     -     |
|  118  |      Пользовательский понтон      |       -       |     -     |
|  119  |          Танковый каток           |       -       |     -     |
|  120  | Деревянный пользовательский блок  |       -       |     +     |
|  121  | Стеклянный пользовательский блок  |       -       |     +     |
|  122  |        Динамическая защита        |       -       |     -     |
|  123  |          Зенитная пушка           |       +       |     -     |
|  124  |       Хэллоуинский огнемёт        |       +       |     -     |
|  125  |          Генератор тона           |       +       |     -     |
|  126  |        Текстовая наклейка         |               |     -     |
|  127  |             Спидометр             |       +       |     -     |
|  128  |      Пользовательское колесо      |       +       |     -     |
|  129  |        Математический блок        |       +       |     -     |
|  130  | Пользовательский светящийся блок  |       +       |     +     |
|  131  |       Маленький амортизатор       |       +       |     -     |



<sup><sub>Благодарность к RuslaNHL за первые два столбца</sub></sup>

Если в какой-либо ячейке пустота, это значит, что информация отсутствует.

Если вы увидели некорректную информацию, то можете написать. Любая помощь приветствуется.

# Метаданные, используемые разными типами блоков

Данный раздел пока что ещё находится в разработке и нуждается в доработке. Любая помощь также приветствуется.


| ID Блока | Используемые метаданные | Что хранится |
| -------- | ----------------------- | ------------ |



<sup><sub>Спецификация разработана Onran'ом на основе предоставленного кода от XMAKE и небольших экспериментов, проведённых в игре.</sub></sup>